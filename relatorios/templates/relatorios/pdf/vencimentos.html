{% extends "relatorios/pdf/base.html" %}

{% block content %}
<!-- Estat√≠sticas -->
<div class="stats-box no-break">
    <h3>Resumo de Vencimentos</h3>
    <table style="width: 100%; margin-bottom: 0;">
        <tbody>
        <tr>
            <td style="border: none;"><strong>Total de Produtos:</strong> {{ stats.total }}</td>
            <td style="border: none;"><strong>Vencidos:</strong> <span class="text-danger">{{ stats.expired_count }}</span></td>
        </tr>
        <tr>
            <td style="border: none;"><strong>Cr√≠ticos (7 dias):</strong> <span class="text-warning">{{ stats.critical_count }}</span></td>
            <td style="border: none;"><strong>Aten√ß√£o (30 dias):</strong> {{ stats.warning_count }}</td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Gr√°fico de Urg√™ncia de Vencimentos -->
<div class="chart-container no-break">
    <div class="chart-title">üìä Distribui√ß√£o por Urg√™ncia</div>
    <div class="bar-chart">
        {% widthratio stats.expired_count stats.total 100 as expired_percent %}
        {% widthratio stats.critical_count stats.total 100 as critical_percent %}
        {% widthratio stats.warning_count stats.total 100 as warning_percent %}
        
        <div class="bar-row">
            <div class="bar-label">Vencidos ({{ stats.expired_count }})</div>
            <div class="bar-container">
                <div class="bar-fill" style="width: {{ expired_percent }}%; background: linear-gradient(90deg, #dc3545 0%, #bd2130 100%);">
                    {% if expired_percent > 10 %}
                    {{ expired_percent }}%
                    {% endif %}
                </div>
            </div>
            <div style="margin-left: 10px; font-size: 9pt; width: 50px;">{{ expired_percent }}%</div>
        </div>
        
        <div class="bar-row">
            <div class="bar-label">Cr√≠ticos - 7 dias ({{ stats.critical_count }})</div>
            <div class="bar-container">
                <div class="bar-fill" style="width: {{ critical_percent }}%; background: linear-gradient(90deg, #fd7e14 0%, #e8590c 100%);">
                    {% if critical_percent > 10 %}
                    {{ critical_percent }}%
                    {% endif %}
                </div>
            </div>
            <div style="margin-left: 10px; font-size: 9pt; width: 50px;">{{ critical_percent }}%</div>
        </div>
        
        <div class="bar-row">
            <div class="bar-label">Aten√ß√£o - 30 dias ({{ stats.warning_count }})</div>
            <div class="bar-container">
                <div class="bar-fill" style="width: {{ warning_percent }}%; background: linear-gradient(90deg, #ffc107 0%, #e0a800 100%);">
                    {% if warning_percent > 10 %}
                    {{ warning_percent }}%
                    {% endif %}
                </div>
            </div>
            <div style="margin-left: 10px; font-size: 9pt; width: 50px;">{{ warning_percent }}%</div>
        </div>
    </div>
</div>

<!-- Produtos Vencidos -->
{% if expired %}
<h3 class="text-danger">‚ö† Produtos Vencidos</h3>
<table>
    <thead>
        <tr>
            <th>Produto</th>
            <th>Categoria</th>
            <th style="text-align: center;">Estoque</th>
            <th style="text-align: center;">Vencimento</th>
            <th style="text-align: center;">Dias Vencido</th>
        </tr>
    </thead>
    <tbody>
        {% for product in expired %}
        <tr style="background-color: #ffebee;">
            <td><strong>{{ product.name }}</strong></td>
            <td>{{ product.category.name }}</td>
            <td style="text-align: center;">{{ product.current_stock }} {{ product.unit.name }}</td>
            <td style="text-align: center;">{{ product.expiry_date|date:"d/m/Y" }}</td>
            <td style="text-align: center;" class="text-danger">
                {{ product.expiry_date|timesince }}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<div class="page-break"></div>
{% endif %}

<!-- Produtos Cr√≠ticos -->
{% if critical %}
<h3 class="text-warning">‚ö° Produtos Cr√≠ticos (Pr√≥ximos 7 dias)</h3>
<table>
    <thead>
        <tr>
            <th>Produto</th>
            <th>Categoria</th>
            <th style="text-align: center;">Estoque</th>
            <th style="text-align: center;">Vencimento</th>
            <th style="text-align: center;">Dias Restantes</th>
        </tr>
    </thead>
    <tbody>
        {% for product in critical %}
        <tr style="background-color: #fff3e0;">
            <td><strong>{{ product.name }}</strong></td>
            <td>{{ product.category.name }}</td>
            <td style="text-align: center;">{{ product.current_stock }} {{ product.unit.name }}</td>
            <td style="text-align: center;">{{ product.expiry_date|date:"d/m/Y" }}</td>
            <td style="text-align: center;" class="text-warning">
                {{ product.expiry_date|timeuntil }}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

<!-- Produtos em Aten√ß√£o -->
{% if warning %}
<h3>üìÖ Produtos Requerem Aten√ß√£o (Pr√≥ximos 30 dias)</h3>
<table>
    <thead>
        <tr>
            <th>Produto</th>
            <th>Categoria</th>
            <th style="text-align: center;">Estoque</th>
            <th style="text-align: center;">Vencimento</th>
            <th style="text-align: center;">Dias Restantes</th>
        </tr>
    </thead>
    <tbody>
        {% for product in warning %}
        <tr>
            <td><strong>{{ product.name }}</strong></td>
            <td>{{ product.category.name }}</td>
            <td style="text-align: center;">{{ product.current_stock }} {{ product.unit.name }}</td>
            <td style="text-align: center;">{{ product.expiry_date|date:"d/m/Y" }}</td>
            <td style="text-align: center;">
                {{ product.expiry_date|timeuntil }}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}
{% endblock %}
