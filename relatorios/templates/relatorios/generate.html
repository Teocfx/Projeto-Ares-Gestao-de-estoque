{% extends "base.html" %}
{% load static block_tags %}

{% block title %}Gerar Relat칩rio Personalizado - Sistema ARES{% endblock %}

{% block body_class %}relatorios-page relatorios-generate-page{% endblock %}

{% block page_header %}
{% include 'include/titulo.html' with titulo="Gerar Relat칩rio Personalizado" subtitulo="Configure e gere relat칩rios customizados" icon="file-earmark-plus" show_actions=True %}
    {% block titulo_actions %}
        <a href="{% url 'relatorios:index' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Voltar
        </a>
    {% endblock %}
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

    <div class="row">
        <!-- Formul치rio de Gera칞칚o -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-bottom">
                    <h5 class="mb-0">
                        <i class="bi bi-gear me-2"></i>Configura칞칫es do Relat칩rio
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'relatorios:generate_custom' %}">
                        {% csrf_token %}
                        
                        <!-- Informa칞칫es B치sicas -->
                        <div class="mb-4">
                            <h6 class="text-muted mb-3">Informa칞칫es B치sicas</h6>
                            
                            <div class="mb-3">
                                <label for="title" class="form-label">
                                    T칤tulo do Relat칩rio <span class="text-danger">*</span>
                                </label>
                                <input type="text" name="title" id="title" class="form-control" 
                                       placeholder="Ex: Relat칩rio de Estoque - Novembro 2025" required>
                                <small class="form-text text-muted">
                                    D칡 um nome descritivo para o relat칩rio
                                </small>
                            </div>

                            <div class="mb-3">
                                <label for="report_type" class="form-label">
                                    Tipo de Relat칩rio <span class="text-danger">*</span>
                                </label>
                                <select name="report_type" id="report_type" class="form-select" required>
                                    <option value="">Selecione o tipo de relat칩rio...</option>
                                    <option value="estoque" data-description="Estoque atual de todos os produtos">
                                        游닍 Relat칩rio de Estoque
                                    </option>
                                    <option value="movimentacoes" data-description="Hist칩rico de entradas e sa칤das">
                                        游댃 Relat칩rio de Movimenta칞칫es
                                    </option>
                                    <option value="vencimentos" data-description="Produtos pr칩ximos ao vencimento">
                                        游늰 Relat칩rio de Vencimentos
                                    </option>
                                    <option value="financeiro" data-description="Valor total do estoque por categoria">
                                        游눯 Relat칩rio Financeiro
                                    </option>
                                </select>
                                <small class="form-text text-muted" id="report_type_description">
                                    Selecione o tipo de relat칩rio para ver a descri칞칚o
                                </small>
                            </div>
                            
                            <div class="mb-3 text-center">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openCreateReportTypeModalFromGenerate()">
                                    <i class="bi bi-plus-square-dotted me-1"></i>Criar Novo Tipo de Relat칩rio
                                </button>
                            </div>
                        </div>

                        <!-- Per칤odo -->
                        <div class="mb-4">
                            <h6 class="text-muted mb-3">Per칤odo</h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="date_from" class="form-label">
                                        Data Inicial
                                    </label>
                                    <input type="date" name="date_from" id="date_from" class="form-control">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="date_to" class="form-label">
                                        Data Final
                                    </label>
                                    <input type="date" name="date_to" id="date_to" class="form-control">
                                </div>
                            </div>
                        </div>

                        <!-- Filtros -->
                        <div class="mb-4">
                            <h6 class="text-muted mb-3">Filtros (Opcional)</h6>
                            
                            <div class="mb-3">
                                <label for="categories" class="form-label">
                                    Categorias
                                </label>
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="dropdownCategoriesButton" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-plus-circle me-2"></i>Adicionar categoria
                                    </button>
                                    <ul class="dropdown-menu w-100" id="categories-dropdown-menu" aria-labelledby="dropdownCategoriesButton">
                                        {% for category in categories %}
                                        <li>
                                            <a class="dropdown-item" href="#" data-category-id="{{ category.id }}" data-category-name="{{ category.name }}">
                                                <i class="bi bi-tag me-2 text-primary"></i>{{ category.name }}
                                            </a>
                                        </li>
                                        {% empty %}
                                        <li><span class="dropdown-item text-muted">Nenhuma categoria dispon칤vel</span></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <!-- Container para tags selecionadas -->
                                <div id="selected-categories-container" class="d-flex flex-wrap gap-2 mt-3 p-3 border rounded" style="min-height: 60px;">
                                    <!-- Tags ser칚o adicionadas aqui via JavaScript -->
                                </div>
                                
                                <!-- Hidden input para enviar categorias selecionadas -->
                                <input type="hidden" name="categories" id="categories_hidden">
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input type="checkbox" name="include_inactive" id="include_inactive" class="form-check-input">
                                    <label class="form-check-label" for="include_inactive">
                                        Incluir produtos inativos
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Formato -->
                        <div class="mb-4">
                            <h6 class="text-muted mb-3">Formato de Sa칤da</h6>
                            
                            <div class="mb-3">
                                <label for="format" class="form-label">
                                    Formato
                                </label>
                                <select name="format" id="format" class="form-select">
                                    <option value="pdf" selected>PDF (Recomendado para impress칚o)</option>
                                    <option value="excel">Excel (.xlsx)</option>
                                    <option value="csv">CSV (para an치lise)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Bot칫es de A칞칚o -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-play-circle me-1"></i>Gerar Relat칩rio
                            </button>
                            <button type="reset" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-clockwise me-1"></i>Limpar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Ajuda e Tipos de Relat칩rio -->
        <div class="col-lg-4">
            <!-- Tipos de Relat칩rio Dispon칤veis -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent border-bottom">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>Tipos de Relat칩rio
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for tipo in report_types %}
                        <div class="list-group-item">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-file-earmark-text text-primary fs-5 me-3"></i>
                                <div>
                                    <h6 class="mb-1">{{ tipo.name }}</h6>
                                    <small class="text-muted">{{ tipo.description }}</small>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="list-group-item text-center text-muted py-4">
                            Nenhum tipo de relat칩rio dispon칤vel
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Dicas -->
            <div class="card border-0 shadow-sm card-dicas">
                <div class="card-body">
                    <h6 class="mb-3">
                        <i class="bi bi-lightbulb me-2 text-warning"></i>
                        <span class="text-dicas-titulo">Dicas</span>
                    </h6>
                    <ul class="small mb-0 ps-3 text-dicas-lista">
                        <li class="mb-2">Use t칤tulos descritivos para facilitar a organiza칞칚o</li>
                        <li class="mb-2">Defina per칤odos espec칤ficos para relat칩rios mais precisos</li>
                        <li class="mb-2">PDF 칠 recomendado para impress칚o e arquivamento</li>
                        <li class="mb-2">Excel/CSV facilita an치lises posteriores</li>
                        <li>Os relat칩rios ficam salvos no hist칩rico por 30 dias</li>
                    </ul>
                </div>
            </div>

            <!-- Relat칩rios R치pidos -->
            <div class="card border-0 shadow-sm mt-4 card-relatorios-rapidos">
                <div class="card-header bg-transparent border-bottom">
                    <h6 class="mb-0">
                        <i class="bi bi-lightning-charge me-2 text-primary"></i>Relat칩rios R치pidos
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <a href="{% url 'relatorios:estoque' %}" class="list-group-item list-group-item-action d-flex align-items-center relatorio-rapido-item">
                            <i class="bi bi-boxes me-3 text-primary fs-5"></i>
                            <div>
                                <div class="fw-medium">Estoque Atual</div>
                                <small class="text-muted">Listagem completa de produtos</small>
                            </div>
                        </a>
                        <a href="{% url 'relatorios:movimentacoes' %}" class="list-group-item list-group-item-action d-flex align-items-center relatorio-rapido-item">
                            <i class="bi bi-arrow-left-right me-3 text-success fs-5"></i>
                            <div>
                                <div class="fw-medium">Movimenta칞칫es</div>
                                <small class="text-muted">Hist칩rico de entradas e sa칤das</small>
                            </div>
                        </a>
                        <a href="{% url 'relatorios:vencimentos' %}" class="list-group-item list-group-item-action d-flex align-items-center relatorio-rapido-item">
                            <i class="bi bi-calendar-x me-3 text-danger fs-5"></i>
                            <div>
                                <div class="fw-medium">Vencimentos</div>
                                <small class="text-muted">Produtos pr칩ximos  validade</small>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
// Array para armazenar categorias selecionadas
let selectedCategories = [];

document.addEventListener('DOMContentLoaded', function() {
    // Sistema de Tags para Categorias
    const categoryItems = document.querySelectorAll('#categories-dropdown-menu .dropdown-item');
    
    categoryItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            
            const categoryId = this.dataset.categoryId;
            const categoryName = this.dataset.categoryName;
            
            // Verificar se categoria j치 foi selecionada
            if (selectedCategories.some(c => c.id === categoryId)) {
                alert('Esta categoria j치 est치 selecionada!');
                return;
            }
            
            // Adicionar ao array
            selectedCategories.push({ id: categoryId, name: categoryName });
            
            // Criar tag visual
            addCategoryTag(categoryId, categoryName);
            
            // Atualizar hidden input
            updateHiddenInput();
        });
    });
    
    // Descri칞칚o do tipo de relat칩rio
    const reportTypeSelect = document.getElementById('report_type');
    if (reportTypeSelect) {
        reportTypeSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const description = selectedOption.dataset.description || 'Selecione o tipo de relat칩rio para ver a descri칞칚o';
            document.getElementById('report_type_description').textContent = description;
        });
    }
});

// Adicionar tag visual de categoria
function addCategoryTag(categoryId, categoryName) {
    const container = document.getElementById('selected-categories-container');
    
    const tag = document.createElement('span');
    tag.className = 'badge bg-primary-subtle text-primary border border-primary dashboard-filter-tag';
    tag.dataset.categoryId = categoryId;
    tag.style.cssText = 'padding: 0.5rem 0.75rem; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.5rem; animation: fadeInScale 0.2s ease-out;';
    tag.innerHTML = `
        <i class="bi bi-tag"></i>${categoryName}
        <button type="button" class="btn-close btn-close-sm" style="width: 0.75rem; height: 0.75rem; font-size: 0.65rem;" onclick="removeCategoryTag('${categoryId}')" aria-label="Remover"></button>
    `;
    
    container.appendChild(tag);
}

// Remover tag de categoria
window.removeCategoryTag = function(categoryId) {
    // Remover do array
    selectedCategories = selectedCategories.filter(c => c.id !== categoryId);
    
    // Remover tag visual
    const tag = document.querySelector(`#selected-categories-container [data-category-id="${categoryId}"]`);
    if (tag) {
        tag.style.animation = 'fadeOutScale 0.2s ease-out';
        setTimeout(() => tag.remove(), 200);
    }
    
    // Atualizar hidden input
    updateHiddenInput();
};

// Atualizar hidden input com categorias selecionadas
function updateHiddenInput() {
    const hiddenInput = document.getElementById('categories_hidden');
    const categoryIds = selectedCategories.map(c => c.id).join(',');
    hiddenInput.value = categoryIds;
}

// Abrir modal de criar novo tipo de relat칩rio
function openCreateReportTypeModalFromGenerate() {
    // Redirecionar para a p치gina principal onde o modal est치
    window.location.href = '{% url "relatorios:index" %}?openModal=createReportType';
}

// Anima칞칫es CSS (adicionar ao head se n칚o existirem)
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeInScale {
        from {
            opacity: 0;
            transform: scale(0.8);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    @keyframes fadeOutScale {
        from {
            opacity: 1;
            transform: scale(1);
        }
        to {
            opacity: 0;
            transform: scale(0.8);
        }
    }
    
    .dashboard-filter-tag {
        transition: all 0.2s ease;
    }
    
    .dashboard-filter-tag:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }
    
    .dashboard-filter-tag .btn-close {
        transition: transform 0.2s ease;
    }
    
    .dashboard-filter-tag .btn-close:hover {
        transform: scale(1.2);
    }
    
    #selected-categories-container:empty::before {
        content: "Nenhuma categoria selecionada";
        color: #999;
        font-style: italic;
        font-size: 0.875rem;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
